"use strict";(self.webpackChunkweb=self.webpackChunkweb||[]).push([[66341],{786141:(e,t,r)=>{r.r(t),r.d(t,{VaultBase:()=>D,VaultBaseChainOnly:()=>S});var n=r(72579),i=r.n(n),o=r(256666),a=r(301842),u=r.n(a),c=r(634795),s=r(887371),d=r(545754),l=r(411987),f=r(695058),p=r(206391),y=r.n(p),h=r(636393),v=r(613549),g=r(292147),w=r(213208),m=r(992431),T=r(940915),I=r(278489),x=r(969618),A=r(398514),E=r(114540),O=r(348834).Buffer;function b(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function P(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?b(Object(r),!0).forEach((function(t){(0,o.default)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):b(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function C(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,f.default)(e);if(t){var i=(0,f.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,l.default)(this,r)}}if(w.default.isExtensionUi)throw new Error("engine/VaultBase is not allowed imported from ui");var S=function(e){(0,d.default)(r,e);var t=C(r);function r(){return t.apply(this,arguments)}var n=r.prototype;return n.initProvider=function(){var e=(0,c.default)((function*(){var e=(yield this.getNetwork()).impl;u()(x.IMPL_MAPPINGS[e])||(this.engineProvider=yield this.engine.providerManager.getProvider(this.networkId))}));return function(){return e.apply(this,arguments)}}(),n.proxyJsonRPCCall=function(){var e=(0,c.default)((function*(e){throw new T.NotImplemented}));return function(t){return e.apply(this,arguments)}}(),n.createClientFromURL=function(e){throw new T.NotImplemented},n.getEthersProvider=function(){var e=(0,c.default)((function*(){throw new T.NotImplemented}));return function(){return e.apply(this,arguments)}}(),n.getClientEndpointStatus=function(){var e=(0,c.default)((function*(e){var t=this.createClientFromURL(e),r=performance.now(),n=(yield t.getInfo()).bestBlockNumber;return{responseTime:Math.floor(performance.now()-r),latestBlock:n}}));return function(t){return e.apply(this,arguments)}}(),n.checkRpcBatchSupport=function(){var e=(0,c.default)((function*(e){throw new T.NotImplemented}));return function(t){return e.apply(this,arguments)}}(),n.getDisplayAddress=function(){var e=(0,c.default)((function*(e){return Promise.resolve(e)}));return function(t){return e.apply(this,arguments)}}(),n.validateAddress=function(){var e=(0,c.default)((function*(e){var t=yield this.engineProvider.verifyAddress(e),r=t.normalizedAddress;if(!t.isValid||!r)throw new T.InvalidAddress;return Promise.resolve(r)}));return function(t){return e.apply(this,arguments)}}(),n.validateImportedCredential=function(e){return Promise.resolve(this.settings.importedAccountEnabled&&/^(0x)?[0-9a-zA-Z]{64}$/.test(e))},n.validateWatchingCredential=function(){var e=(0,c.default)((function*(e){return Promise.resolve(this.settings.watchingAccountEnabled&&(yield this.engineProvider.verifyAddress(e)).isValid)}));return function(t){return e.apply(this,arguments)}}(),n.validateTokenAddress=function(){var e=(0,c.default)((function*(e){var t=yield this.engineProvider.verifyTokenAddress(e),r=t.normalizedAddress;if(!t.isValid||"undefined"===typeof r)throw new T.InvalidTokenAddress;return Promise.resolve(r)}));return function(t){return e.apply(this,arguments)}}(),n.validateCanCreateNextAccount=function(){var e=(0,c.default)((function*(e,t){return Promise.resolve(!0)}));return function(t,r){return e.apply(this,arguments)}}(),n.checkAccountExistence=function(){var e=(0,c.default)((function*(e,t){return Promise.resolve(!0)}));return function(t,r){return e.apply(this,arguments)}}(),n.getBalances=function(){var e=(0,c.default)((function*(e,t,r){return(yield this.engine.providerManager.getClient(this.networkId)).getBalances(e.map((function(e){var t=e.address,r=e.tokenAddress;return{address:t,coin:P({},"string"===typeof r?{tokenAddress:r}:{})}})))}));return function(t,r,n){return e.apply(this,arguments)}}(),n.getFrozenBalance=function(){var e=(0,c.default)((function*(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.password,e.useRecycleBalance,e.ignoreInscriptions,e.useCustomAddressesBalance;return 0}));return function(){return e.apply(this,arguments)}}(),n.fetchBalanceDetails=function(){var e=(0,c.default)((function*(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.password,e.useRecycleBalance,e.ignoreInscriptions,e.useCustomAddressesBalance;return Promise.resolve(void 0)}));return function(){return e.apply(this,arguments)}}(),n.getTransactionStatuses=function(e){return this.engine.providerManager.getTransactionStatuses(this.networkId,e)},n.getTransactionFeeInNative=function(e){return Promise.resolve("")},n.isContractAddress=function(){var e=(0,c.default)((function*(e){return!1}));return function(t){return e.apply(this,arguments)}}(),n.getAccountNameInfoMap=function(){var e=(0,c.default)((function*(){var e=yield this.getNetwork();return(0,I.getAccountNameInfoByImpl)(e.impl)}));return function(){return e.apply(this,arguments)}}(),n.canAutoCreateNextAccount=function(){var e=(0,c.default)((function*(e){return Promise.resolve(!1)}));return function(t){return e.apply(this,arguments)}}(),n.filterAccounts=function(){var e=(0,c.default)((function*(e){var t=e.accounts;e.networkId;return Promise.resolve(t)}));return function(t){return e.apply(this,arguments)}}(),n.shouldChangeAccountWhenNetworkChanged=function(){var e=(0,c.default)((function*(e){e.previousNetwork,e.newNetwork,e.activeAccountId;return Promise.resolve({shouldReloadAccountList:!1,shouldChangeActiveAccount:!1})}));return function(t){return e.apply(this,arguments)}}(),n.getAccountNameInfosByImportedOrWatchingCredential=function(){var e=(0,c.default)((function*(e){return Promise.resolve([])}));return function(t){return e.apply(this,arguments)}}(),n.checkIsUnlimitedAllowance=function(){var e=(0,c.default)((function*(e){throw new T.NotImplemented}));return function(t){return e.apply(this,arguments)}}(),n.checkIsApprovedForAll=function(){var e=(0,c.default)((function*(e){throw new T.NotImplemented}));return function(t){return e.apply(this,arguments)}}(),n.checkIsBatchTransfer=function(){var e=(0,c.default)((function*(e){throw new T.NotImplemented}));return function(t){return e.apply(this,arguments)}}(),n.getFeePricePerUnit=function(){var e=(0,c.default)((function*(){throw new T.NotImplemented}));return function(){return e.apply(this,arguments)}}(),n.fetchRpcChainId=function(){var e=(0,c.default)((function*(e){return null}));return function(t){return e.apply(this,arguments)}}(),n.getTxWaitingSeconds=function(){var e=(0,c.default)((function*(){return[]}));return function(){return e.apply(this,arguments)}}(),n.getUserNFTAssets=function(){var e=(0,c.default)((function*(e){e.serviceData;return Promise.resolve(void 0)}));return function(t){return e.apply(this,arguments)}}(),n.getTransactionDetail=function(){var e=(0,c.default)((function*(e){return Promise.resolve(void 0)}));return function(t){return e.apply(this,arguments)}}(),(0,s.default)(r)}(E.VaultContext),D=function(e){(0,d.default)(r,e);var t=C(r);function r(){for(var e,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(e=t.call.apply(t,[this].concat(n))).uuid=h.default.v4().toString(),e}var n=r.prototype;return n.init=function(){var e=(0,c.default)((function*(e){yield this.initProvider(),yield this.initKeyring(e)}));return function(t){return e.apply(this,arguments)}}(),n.initKeyring=function(){var e=(0,c.default)((function*(e){this.keyring=yield e.keyringCreator(this)}));return function(t){return e.apply(this,arguments)}}(),n.signTransaction=function(){var e=(0,c.default)((function*(e,t){return this.keyring.signTransaction(e,t)}));return function(t,r){return e.apply(this,arguments)}}(),n.signAndSendTransaction=function(){var e=(0,c.default)((function*(e,t,r){var n=yield this.signTransaction(e,t);return r?P(P({},n),{},{encodedTx:e.encodedTx}):this.broadcastTransaction(P(P({},n),{},{encodedTx:e.encodedTx}))}));return function(t,r,n){return e.apply(this,arguments)}}(),n.broadcastTransaction=function(){var e=(0,c.default)((function*(e,t){g.default.engine.info("broadcastTransaction START:",{rawTx:e.rawTx});var r=yield this.engine.providerManager.broadcastTransaction(this.networkId,e.rawTx,t);return g.default.engine.info("broadcastTransaction END:",{txid:r,rawTx:e.rawTx}),P(P({},e),{},{txid:r,encodedTx:e.encodedTx})}));return function(t,r){return e.apply(this,arguments)}}(),n.buildEncodedTxFromBatchTransfer=function(){var e=(0,c.default)((function*(e){throw new T.NotImplemented}));return function(t){return e.apply(this,arguments)}}(),n.buildEncodedTxsFromSetApproveForAll=function(){var e=(0,c.default)((function*(e,t){throw new T.NotImplemented}));return function(t,r){return e.apply(this,arguments)}}(),n.activateAccount=function(){var e=(0,c.default)((function*(){throw new T.NotImplemented}));return function(){return e.apply(this,arguments)}}(),n.activateToken=function(){var e=(0,c.default)((function*(e,t){throw new T.NotImplemented}));return function(t,r){return e.apply(this,arguments)}}(),n.getTokenAllowance=function(){var e=(0,c.default)((function*(e,t){throw new T.NotImplemented}));return function(t,r){return e.apply(this,arguments)}}(),n.batchTokensAllowance=function(){var e=(0,c.default)((function*(e,t){throw new T.NotImplemented}));return function(t,r){return e.apply(this,arguments)}}(),n.getOutputAccount=function(){var e=(0,c.default)((function*(){var e=yield this.getDbAccount({noCache:!0});return{id:e.id,name:e.name,type:e.type,path:e.path,coinType:e.coinType,tokens:[],address:e.address,template:e.template,pubKey:i()(e,"pub","")}}));return function(){return e.apply(this,arguments)}}(),n.getAccountBalance=function(){var e=(0,c.default)((function*(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,i=(yield this.getDbAccount()).address;return this.getBalances((t?[{address:i}]:[]).concat(e.map((function(e){return{address:i,tokenAddress:e}}))),r,n)}));return function(t){return e.apply(this,arguments)}}(),n.updatePendingTxs=function(){var e=(0,c.default)((function*(e){throw new T.NotImplemented}));return function(t){return e.apply(this,arguments)}}(),n.getAccountNonce=function(){var e=(0,c.default)((function*(){return Promise.resolve(null)}));return function(){return e.apply(this,arguments)}}(),n.fixActionDirection=function(){var e=(0,c.default)((function*(e){var t,r,n,i,o=e.action,a=e.accountAddress;(o.direction=A.IDecodedTxDirection.OTHER,o.type===A.IDecodedTxActionType.NATIVE_TRANSFER)&&(o.direction=yield this.buildTxActionDirection({from:(null==(t=o.nativeTransfer)?void 0:t.from)||"",to:(null==(r=o.nativeTransfer)?void 0:r.to)||"",address:a}));o.type===A.IDecodedTxActionType.TOKEN_TRANSFER&&(o.direction=yield this.buildTxActionDirection({from:(null==(n=o.tokenTransfer)?void 0:n.from)||"",to:(null==(i=o.tokenTransfer)?void 0:i.to)||"",address:a}));return o}));return function(t){return e.apply(this,arguments)}}(),n.fixDecodedTx=function(){var e=(0,c.default)((function*(e){var t,r;e.createdAt=null!=(t=e.createdAt)?t:Date.now();var n=null==(r=e.encodedTx)?void 0:r.nonce;e.nonce=u()(n)?e.nonce:new(y())(n).toNumber();for(var i=e.owner,o=0;o<e.actions.length;o+=1){var a=e.actions[o];yield this.fixActionDirection({action:a,accountAddress:i})}if(e.outputActions)for(var c=0;c<e.outputActions.length;c+=1){var s=e.outputActions[c];yield this.fixActionDirection({action:s,accountAddress:i})}return Promise.resolve(e)}));return function(t){return e.apply(this,arguments)}}(),n.fixHistoryTx=function(){var e=(0,c.default)((function*(e){return e.decodedTx=yield this.fixDecodedTx(e.decodedTx),Promise.resolve(e)}));return function(t){return e.apply(this,arguments)}}(),n.buildHistoryTx=function(){var e=(0,c.default)((function*(e){var t=e.historyTxToMerge,r=(e.encodedTx,e.decodedTx),n=e.signedTx,i=e.isSigner,o=e.isLocalCreated,a=(null==n?void 0:n.txid)||(null==r?void 0:r.txid)||"";if(!a)throw new Error("buildHistoryTx txid not found");var u=yield this.getAccountAddress();r.txid=a||r.txid,r.owner=u,i&&(r.signer=u),null!=n&&n.txKey&&(r.extraInfo?r.extraInfo.txKey=n.txKey:r.extraInfo={txKey:n.txKey});var c=P(P({id:`${this.networkId}_${a}_${this.accountId}`,isLocalCreated:Boolean(o)},t),{},{decodedTx:r});return c=yield this.fixHistoryTx(c),Promise.resolve(c)}));return function(t){return e.apply(this,arguments)}}(),n.checkIsScamHistoryTx=function(){var e=(0,c.default)((function*(e){return!1}));return function(t){return e.apply(this,arguments)}}(),n.fetchOnChainHistory=function(){var e=(0,c.default)((function*(e){throw new T.NotImplemented}));return function(t){return e.apply(this,arguments)}}(),n.fixAddressCase=function(e){return Promise.resolve(e)},n.buildTxActionDirection=function(){var e=(0,c.default)((function*(e){var t=e.from,r=e.to,n=e.address;return t=yield this.fixAddressCase(t||""),r=yield this.fixAddressCase(r),n=yield this.fixAddressCase(n),t===r&&t===n?A.IDecodedTxDirection.SELF:t&&t===n?A.IDecodedTxDirection.OUT:r&&r===n?A.IDecodedTxDirection.IN:A.IDecodedTxDirection.OTHER}));return function(t){return e.apply(this,arguments)}}(),n.getNextNonce=function(){var e=(0,c.default)((function*(e,t){var r,n=null==(r=(yield this.engine.providerManager.getAddresses(e,[t.address]))[0])?void 0:r.nonce;if(u()(n))throw new T.OneKeyError("Get on-chain nonce failed.");yield this.engine.getHistory(e,t.id,void 0,!1);var i=yield m.default.history.getMaxPendingNonce({accountId:this.accountId,networkId:e}),o=yield m.default.history.getPendingNonceList({accountId:this.accountId,networkId:e}),a=Math.max(u()(i)?0:i+1,n);if(Number.isNaN(a)&&(a=n),a>n)for(var c=n;c<a;c+=1)if(!o.includes(c)){a=c;break}if(a<n&&(a=n),a-n>=v.HISTORY_CONSTS.PENDING_QUEUE_MAX_LENGTH)throw new T.PendingQueueTooLong(v.HISTORY_CONSTS.PENDING_QUEUE_MAX_LENGTH);return a}));return function(t,r){return e.apply(this,arguments)}}(),n.validateSendAmount=function(e,t,r){return Promise.resolve(!0)},n.notifyChainChanged=function(e,t){},n.getFetchBalanceAddress=function(e){return Promise.resolve(e.address)},n.getPrivateKeyByCredential=function(e){return Promise.resolve(O.from(e.startsWith("0x")?e.slice(2):e,"hex"))},n.getMinDepositAmount=function(){var e=(0,c.default)((function*(){return"0"}));return function(){return e.apply(this,arguments)}}(),n.specialCheckEncodedTx=function(){var e=(0,c.default)((function*(e){return{success:!0}}));return function(t){return e.apply(this,arguments)}}(),n.getAllUsedAddress=function(){var e=(0,c.default)((function*(){return Promise.resolve([])}));return function(){return e.apply(this,arguments)}}(),(0,s.default)(r)}(S)},466341:(e,t,r)=>{r.r(t),r.d(t,{default:()=>de});var n=r(459740),i=r(545455),o=r.n(i),a=r(256666),u=r(196234),c=r(703440),s=r.n(c),d=r(301842),l=r.n(d),f=r(72579),p=r.n(f),y=r(634795),h=r(887371),v=r(545754),g=r(411987),w=r(695058),m=r(84658),T=r(573826),I=r(206391),x=r.n(I),A=r(901187),E=r(740727),O=r(776553),b=r(627009),P=r(292147),C=r(396564),S=r(940915),D=r(398514),N=r(392853),B=r(368652),k=r(786141),_=r(153546),R=r(613549),H=r(398145),F=r(82406),K=r(598165);function U(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function M(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?U(Object(r),!0).forEach((function(t){(0,a.default)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):U(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function j(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,w.default)(e);if(t){var i=(0,w.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,g.default)(this,r)}}var L=`m/44'/${R.COINTYPE_APTOS}'`,V=function(e){(0,v.default)(r,e);var t=j(r);function r(){return t.apply(this,arguments)}var n=r.prototype;return n.getPublicKey=function(){var e=(0,y.default)((function*(e,t,r){var n,i=yield this.getHardwareSDKInstance(),o=yield this.getWalletPassphraseState();try{n=yield i.aptosGetPublicKey(e,t,M({bundle:r.map((function(e){return{path:e}}))},o))}catch(a){throw P.default.common.error(a),new S.OneKeyHardwareError(a)}if(!n.success)throw P.default.common.error(n.payload),(0,_.convertDeviceError)(n.payload);return n.payload.map((function(e){return e.publicKey})).filter((function(e){return!!e}))}));return function(t,r,n){return e.apply(this,arguments)}}(),n.prepareAccounts=function(){var e=(0,y.default)((function*(e){var t,r=e.type,n=e.indexes,i=e.names,o=n.map((function(e){return`${L}/${e}'/0'/0'`})),a="SEARCH_ACCOUNTS"===r,u=yield this.getHardwareSDKInstance(),c=yield this.getHardwareInfo(),s=c.connectId,d=c.deviceId,l=yield this.getWalletPassphraseState();try{t=yield u.aptosGetAddress(s,d,M({bundle:o.map((function(e){return{path:e,showOnOneKey:false}}))},l))}catch(x){throw P.default.common.error(x),new S.OneKeyHardwareError(x)}if(!t.success)throw P.default.common.error(t.payload),(0,_.convertDeviceError)(t.payload);var f,p,y=[];a||(!(null==(f=t.payload)||null==(p=f[0])||!p.publicKey)||(y=yield this.getPublicKey(s,d,o)));var h=[],v=0;for(var g of t.payload){var w=g.address,m=g.path,T=g.publicKey;if(w){var I=(i||[])[v]||`APT #${n[v]+1}`;h.push({id:`${this.walletId}--${m}`,name:I,type:H.AccountType.SIMPLE,path:m,coinType:R.COINTYPE_APTOS,pub:null!=T?T:y[v]||"",address:(0,B.addHexPrefix)(w)}),v+=1}}return h}));return function(t){return e.apply(this,arguments)}}(),n.getAddress=function(){var e=(0,y.default)((function*(e){var t,r=yield this.getHardwareSDKInstance(),n=yield this.getHardwareInfo(),i=n.connectId,o=n.deviceId,a=yield this.getWalletPassphraseState(),u=yield r.aptosGetAddress(i,o,M({path:e.path,showOnOneKey:e.showOnOneKey},a));if(u.success&&null!=(t=u.payload)&&t.address)return u.payload.address.toLowerCase();throw(0,_.convertDeviceError)(u.payload)}));return function(t){return e.apply(this,arguments)}}(),n.batchGetAddress=function(){var e=(0,y.default)((function*(e){var t=yield this.getHardwareSDKInstance(),r=yield this.getHardwareInfo(),n=r.connectId,i=r.deviceId,o=yield this.getWalletPassphraseState(),a=yield t.aptosGetAddress(n,i,M(M({},o),{},{bundle:e.map((function(e){return{path:e.path,showOnOneKey:!!e.showOnOneKey}}))}));if(!a.success)throw(0,_.convertDeviceError)(a.payload);return a.payload.map((function(e){var t,r;return{path:null!=(t=e.path)?t:"",address:null!=(r=e.address)?r:""}}))}));return function(t){return e.apply(this,arguments)}}(),n.signTransaction=function(){var e=(0,y.default)((function*(e,t){P.default.common.info("signTransaction",e);var r=yield this.getDbAccount(),n=(yield this.engine.getNetwork(this.networkId)).rpcURL,i=new T.AptosClient(n),o=yield(0,K.generateUnsignedTransaction)(i,e),a=new T.BCS.Serializer;o.serialize(a);var u=yield this.getHardwareInfo(),c=u.connectId,s=u.deviceId,d=yield this.getWalletPassphraseState(),l=yield this.getHardwareSDKInstance(),f=yield l.aptosSignTransaction(c,s,M({path:r.path,rawTx:(0,m.bytesToHex)(a.getBytes())},d));if(f.success){var p=f.payload,y=p.signature,h=p.public_key;return(0,K.buildSignedTx)(o,h,y)}throw(0,_.convertDeviceError)(f.payload)}));return function(t,r){return e.apply(this,arguments)}}(),n.signMessage=function(){var e=(0,y.default)((function*(e,t){P.default.common.info("signMessage",e);var r=yield this.getDbAccount(),n=yield this.getHardwareInfo(),i=n.connectId,o=n.deviceId,a=yield this.getWalletPassphraseState(),u=yield this.getHardwareSDKInstance();return Promise.all(e.map(function(){var e=(0,y.default)((function*(e){var t,n,c=JSON.parse(e.message),s=yield u.aptosSignMessage(i,o,M({path:r.path,payload:{message:c.message,address:c.address,application:c.application,chainId:null==c||null==(t=c.chainId)?void 0:t.toString(),nonce:null==c||null==(n=c.nonce)?void 0:n.toString()}},a));if(!s.success)throw(0,_.convertDeviceError)(s.payload);return(0,B.addHexPrefix)(s.payload.signature)}));return function(t){return e.apply(this,arguments)}}()))}));return function(t,r){return e.apply(this,arguments)}}(),(0,h.default)(r)}(F.KeyringHardwareBase),$=r(883669),G=r(605851),W=r(794292),z=r(810887),Y=r(348834).Buffer;function q(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,w.default)(e);if(t){var i=(0,w.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,g.default)(this,r)}}var J=`m/44'/${R.COINTYPE_APTOS}'`,Q=function(e){(0,v.default)(r,e);var t=q(r);function r(){return t.apply(this,arguments)}var n=r.prototype;return n.getSigners=function(){var e=(0,y.default)((function*(e,t){var r,n=yield this.getDbAccount();if(1!==t.length)throw new S.OneKeyInternalError("Starcoin signers number should be 1.");if(t[0]!==n.address)throw new S.OneKeyInternalError("Wrong address required for signing.");var i=(yield this.getPrivateKeys(e))[n.path];if("undefined"===typeof i)throw new S.OneKeyInternalError("Unable to get signer.");return(r={})[n.address]=new W.Signer(i,e,"ed25519"),r}));return function(t,r){return e.apply(this,arguments)}}(),n.prepareAccounts=function(){var e=(0,y.default)((function*(e){var t=e.password,r=e.indexes,n=e.names,i=(yield this.engine.dbApi.getCredential(this.walletId,t)).seed,o=(0,G.batchGetPublicKeys)("ed25519",i,t,J,r.map((function(e){return`${e.toString()}'/0'/0'`})));if(o.length!==r.length)throw new S.OneKeyInternalError("Unable to get publick key.");var a=[],u=0;for(var c of o){var s=c.path,d=c.extendedKey.key,l=d.toString("hex"),f=$.sha3_256.create();f.update(d),f.update("\0");var p=(0,B.addHexPrefix)(f.hex()),y=(n||[])[u]||`APT #${r[u]+1}`;a.push({id:`${this.walletId}--${s}`,name:y,type:H.AccountType.SIMPLE,path:s,coinType:R.COINTYPE_APTOS,pub:l,address:p}),u+=1}return a}));return function(t){return e.apply(this,arguments)}}(),n.signTransaction=function(){var e=(0,y.default)((function*(e,t){var r,n;P.default.common.info("signTransaction result",e);var i=yield this.getDbAccount(),o=(yield this.engine.getNetwork(this.networkId)).rpcURL,a=new T.AptosClient(o),u=(yield this.getSigners(t.password||"",[i.address]))[i.address],c=null==(r=e.inputs)||null==(n=r[0])?void 0:n.publicKey;if(!c)throw new S.OneKeyInternalError("Unable to get sender public key.");var s=yield(0,K.generateUnsignedTransaction)(a,e);return(0,K.signRawTransaction)(u,c,s)}));return function(t,r){return e.apply(this,arguments)}}(),n.signMessage=function(){var e=(0,y.default)((function*(e,t){var r=yield this.getDbAccount(),n=(yield this.getSigners(t.password||"",[r.address]))[r.address];return Promise.all(e.map(function(){var e=(0,y.default)((function*(e){var t=JSON.parse(e.message).fullMessage,r=yield n.sign(Y.from(t)),i=(0,u.default)(r,1)[0];return(0,B.addHexPrefix)(i.toString("hex"))}));return function(t){return e.apply(this,arguments)}}()))}));return function(t,r){return e.apply(this,arguments)}}(),(0,h.default)(r)}(z.KeyringHdBase),X=r(478557),Z=r(255942),ee=r(348834).Buffer;function te(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,w.default)(e);if(t){var i=(0,w.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,g.default)(this,r)}}var re=function(e){(0,v.default)(r,e);var t=te(r);function r(){return t.apply(this,arguments)}var n=r.prototype;return n.getSigners=function(){var e=(0,y.default)((function*(e,t){var r,n=yield this.getDbAccount();if(1!==t.length)throw new S.OneKeyInternalError("Starcoin signers number should be 1.");if(t[0]!==n.address)throw new S.OneKeyInternalError("Wrong address required for signing.");var i=(yield this.getPrivateKeys(e))[n.path];if("undefined"===typeof i)throw new S.OneKeyInternalError("Unable to get signer.");return(r={})[n.address]=new W.Signer(i,e,"ed25519"),r}));return function(t,r){return e.apply(this,arguments)}}(),n.prepareAccounts=function(){var e=(0,y.default)((function*(e){var t=e.privateKey,r=e.name;if(32!==t.length)throw new S.OneKeyInternalError("Invalid private key.");var n=X.ed25519.publicFromPrivate(t),i=n.toString("hex"),o=$.sha3_256.create();o.update(n),o.update("\0");var a=(0,B.addHexPrefix)(o.hex());return Promise.resolve([{id:`imported--${R.COINTYPE_APTOS}--${i}`,name:r||"",type:H.AccountType.SIMPLE,path:"",coinType:R.COINTYPE_APTOS,pub:i,address:a}])}));return function(t){return e.apply(this,arguments)}}(),n.signTransaction=function(){var e=(0,y.default)((function*(e,t){var r,n,i=yield this.getDbAccount(),o=(yield this.engine.getNetwork(this.networkId)).rpcURL,a=new T.AptosClient(o),u=yield this.getSigners(t.password||"",[i.address]),c=null==(r=e.inputs)||null==(n=r[0])?void 0:n.publicKey;if(!c)throw new S.OneKeyInternalError("Unable to get sender public key.");var s=u[i.address],d=yield(0,K.generateUnsignedTransaction)(a,e);return(0,K.signRawTransaction)(s,c,d)}));return function(t,r){return e.apply(this,arguments)}}(),n.signMessage=function(){var e=(0,y.default)((function*(e,t){var r=yield this.getDbAccount(),n=(yield this.getSigners(t.password||"",[r.address]))[r.address];return Promise.all(e.map(function(){var e=(0,y.default)((function*(e){var t=yield n.sign(ee.from(e));return(0,u.default)(t,1)[0].toString("hex")}));return function(t){return e.apply(this,arguments)}}()))}));return function(t,r){return e.apply(this,arguments)}}(),(0,h.default)(r)}(Z.KeyringImportedBase);function ne(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,w.default)(e);if(t){var i=(0,w.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,g.default)(this,r)}}var ie=function(e){(0,v.default)(r,e);var t=ne(r);function r(){return t.apply(this,arguments)}return r.prototype.prepareAccounts=function(){var e=(0,y.default)((function*(e){var t=e.name,r=e.target,n=e.accountIdPrefix,i=yield this.vault.validateAddress(r);if("undefined"===typeof i)throw new S.InvalidAddress;return Promise.resolve([{id:`${n}--${R.COINTYPE_APTOS}--${r}`,name:t||"",type:H.AccountType.SIMPLE,path:"",coinType:R.COINTYPE_APTOS,pub:"",address:i}])}));return function(t){return e.apply(this,arguments)}}(),(0,h.default)(r)}(r(701625).KeyringWatchingBase),oe=r(785114),ae=["max_gas_amount"];function ue(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function ce(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ue(Object(r),!0).forEach((function(t){(0,a.default)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ue(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function se(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,w.default)(e);if(t){var i=(0,w.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,g.default)(this,r)}}var de=function(e){(0,v.default)(r,e);var t=se(r);function r(){for(var e,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(e=t.call.apply(t,[this].concat(n))).keyringMap={hd:Q,hw:V,imported:re,watching:ie,external:ie},e.settings=oe.default,e.getClientCache=(0,C.memoizee)(function(){var t=(0,y.default)((function*(t){return e.getAptosClient(t)}));return function(e){return t.apply(this,arguments)}}(),{promise:!0,max:1,maxAge:(0,O.getTimeDurationMs)({minute:3})}),e}var i=r.prototype;return i.getClient=function(){var e=(0,y.default)((function*(){var e=yield this.getRpcUrl();return this.getClientCache(e)}));return function(){return e.apply(this,arguments)}}(),i.getAptosClient=function(e){return new T.AptosClient(e)},i.getClientEndpointStatus=function(){var e=(0,y.default)((function*(e){var t=yield this.getClientCache(e),r=performance.now(),n=(yield t.getLedgerInfo()).block_height,i=parseInt(n);return{responseTime:Math.floor(performance.now()-r),latestBlock:i}}));return function(t){return e.apply(this,arguments)}}(),i._getPublicKey=function(){var e=(0,y.default)((function*(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).prefix,t=void 0===e||e,r=(yield this.getDbAccount()).pub;return t&&(r=(0,B.addHexPrefix)(r)),Promise.resolve(r)}));return function(){return e.apply(this,arguments)}}(),i.validateAddress=function(){var e=(0,y.default)((function*(e){return(0,O.isHexString)(e)&&64===(0,B.stripHexPrefix)(e).length?Promise.resolve(e):Promise.reject(new S.InvalidAddress)}));return function(t){return e.apply(this,arguments)}}(),i.validateWatchingCredential=function(){var e=(0,y.default)((function*(e){var t=this;return this.validateAddress(e).then((function(e){return t.settings.watchingAccountEnabled&&!!e})).catch((function(){return!1}))}));return function(t){return e.apply(this,arguments)}}(),i.checkAccountExistence=function(){var e=(0,y.default)((function*(e){var t=yield this.getClient();try{var r=yield t.getAccount((0,B.stripHexPrefix)(e)),n=p()(r,"authentication_key",null);return!l()(n)}catch(i){if("resource_not_found"===p()(i,"errorCode",null))return!1;throw i}}));return function(t){return e.apply(this,arguments)}}(),i.getBalances=function(){var e=(0,y.default)((function*(e){var t=yield this.getClient(),r=s()(e,(function(e){return e.address})),n=new Map;return yield Promise.all(Object.entries(r).map(function(){var e=(0,y.default)((function*(e){var r=(0,u.default)(e,2),i=r[0],o=r[1];try{var a=yield(0,K.getAccountResource)(t,i);o.forEach((function(e){var t=e.tokenAddress,r=`${K.APTOS_COINSTORE}<${null!=t?t:K.APTOS_NATIVE_COIN}>`,o=null==a?void 0:a.find((function(e){return e.type===r})),u=p()(o,"data.coin.value",0),c=`${i}-${null!=t?t:K.APTOS_NATIVE_COIN}`;try{n.set(c,new(x())(u))}catch(s){}}))}catch(c){}}));return function(t){return e.apply(this,arguments)}}())),e.map((function(e){var t,r=e.address,i=e.tokenAddress,o=`${r}-${null!=i?i:K.APTOS_NATIVE_COIN}`;return null!=(t=n.get(o))?t:new(x())(0)}))}));return function(t){return e.apply(this,arguments)}}(),i.fetchTokenInfos=function(){var e=(0,y.default)((function*(e){var t=yield this.getClient();return Promise.all(e.map(function(){var e=(0,y.default)((function*(e){try{return yield(0,K.getTokenInfo)(t,e)}catch(r){}}));return function(t){return e.apply(this,arguments)}}()))}));return function(t){return e.apply(this,arguments)}}(),i.activateAccount=function(){var e=(0,y.default)((function*(){(0,b.openDapp)("https://aptoslabs.com/testnet-faucet")}));return function(){return e.apply(this,arguments)}}(),i.activateToken=function(){var e=(0,y.default)((function*(e,t){var r=(yield this.getDbAccount()).address;if(yield(0,K.getAccountCoinResource)(yield this.getClient(),r,e))return Promise.resolve(!0);var n=(0,K.generateRegisterToken)(e);n.sender=r,n.forcePendingTx=!0;var i=yield this.buildUnsignedTxFromEncodedTx(n);return i.payload=ce(ce({},i.payload),{},{encodedTx:n}),!!(yield this.signAndSendTransaction(i,{password:t},!1)).txid}));return function(t,r){return e.apply(this,arguments)}}(),i.validateTokenAddress=function(){var e=(0,y.default)((function*(e){var t=e.split("::"),r=(0,u.default)(t,3),n=r[0],i=r[1],o=r[2];if(i&&o)try{return`${(yield this.validateAddress((0,B.hexlify)(n,{hexPad:"left"}))).toLowerCase()}::${i}::${o}`}catch(a){}throw new S.InvalidTokenAddress}));return function(t){return e.apply(this,arguments)}}(),i.attachFeeInfoToEncodedTx=function(){var e=(0,y.default)((function*(e){var t=e.feeInfoValue,r=t.price,n=t.limit;if("undefined"!==typeof r&&"string"!==typeof r)throw new S.OneKeyInternalError("Invalid gas price.");if("string"!==typeof n)throw new S.OneKeyInternalError("Invalid fee limit");var i=yield this.getNetwork(),a=(0,N.convertFeeGweiToValue)({value:r||"0.000000001",network:i}),u=e.encodedTx.bscTxn;if(!l()(u)&&!o()(u)){var c=new T.BCS.Deserializer((0,m.hexToBytes)(u)),s=T.TxnBuilderTypes.RawTransaction.deserialize(c),d=new T.TxnBuilderTypes.RawTransaction(s.sender,s.sequence_number,s.payload,BigInt(n),BigInt(a),s.expiration_timestamp_secs,s.chain_id),f=new T.BCS.Serializer;d.serialize(f),u=(0,m.bytesToHex)(f.getBytes())}var p=ce(ce({},e.encodedTx),{},{gas_unit_price:a,max_gas_amount:n,bscTxn:u});return Promise.resolve(p)}));return function(t){return e.apply(this,arguments)}}(),i.decodedTxToLegacy=function(e){return Promise.resolve({})},i.decodeTx=function(){var e=(0,y.default)((function*(e,t){var r,n=yield this.engine.getNetwork(this.networkId),i=yield this.getDbAccount(),o=yield this.engine.getNativeTokenInfo(this.networkId),a=e.type,c=e.function,s=e.type_arguments;null!=e&&e.sender||(e.sender=i.address);var d=null,l=(0,K.getTransactionTypeByPayload)({type:null!=a?a:"entry_function_payload",function_name:c,type_arguments:s});if(l===D.IDecodedTxActionType.NATIVE_TRANSFER||l===D.IDecodedTxActionType.TOKEN_TRANSFER){var f,p=l===D.IDecodedTxActionType.TOKEN_TRANSFER,y=e.sender,h=e.type_arguments||[],v=(0,u.default)(h,1)[0],g=e.arguments||[],w=(0,u.default)(g,2),m=w[0],T=w[1],I="nativeTransfer";if(p&&(I="tokenTransfer",!(o=yield this.engine.ensureTokenInDB(this.networkId,v)))){var A=yield this.fetchTokenInfos([v]),E=(0,u.default)(A,1)[0];if(E&&(o={id:"1",isNative:!1,networkId:this.networkId,tokenIdOnNetwork:v,name:E.name,symbol:E.symbol,decimals:E.decimals,logoURI:""}),!o)throw new Error("Invalid token address")}var O={tokenInfo:o,from:null!=y?y:"",to:m,amount:new(x())(T).shiftedBy(-o.decimals).toFixed(),amountValue:T,extraInfo:null};(f={type:l})[I]=O,d=f}else if(l===D.IDecodedTxActionType.FUNCTION_CALL){var b,P;d={type:D.IDecodedTxActionType.FUNCTION_CALL,direction:D.IDecodedTxDirection.OTHER,functionCall:{target:e.sender,functionName:null!=c?c:"",args:null!=(b=null==(P=e.arguments)?void 0:P.map((function(e){if("string"===typeof e||"number"===typeof e||"boolean"===typeof e||"bigint"===typeof e)return e.toString();if(e instanceof Array)try{return(0,B.hexlify)(e)}catch(t){return JSON.stringify(e)}return""})))?b:[],extraInfo:{}}}}else d={type:D.IDecodedTxActionType.UNKNOWN,direction:D.IDecodedTxDirection.OTHER,unknownAction:{extraInfo:{}}};var C={txid:"",owner:i.address,signer:i.address,nonce:0,actions:[d],status:D.IDecodedTxStatus.Pending,networkId:this.networkId,accountId:this.accountId,feeInfo:{price:(0,N.convertFeeValueToGwei)({value:null!=(r=e.gas_unit_price)?r:"1",network:n}),limit:e.max_gas_amount},extraInfo:null,encodedTx:e};return Promise.resolve(C)}));return function(t,r){return e.apply(this,arguments)}}(),i.buildEncodedTxFromTransfer=function(){var e=(0,y.default)((function*(e){if(!e.to)throw new Error("Invalid transferInfo.to params");var t,r=e.to,n=e.amount,i=e.token,o=(yield this.getDbAccount()).address;if(i&&""!==i){var a=yield this.engine.ensureTokenInDB(this.networkId,i);if("undefined"===typeof a)throw new S.OneKeyInternalError("Failed to get token info.");t=new(x())(n).shiftedBy(a.decimals).toFixed()}else{var u=yield this.getNetwork();t=new(x())(n).shiftedBy(u.decimals).toFixed()}return ce(ce({},(0,K.generateTransferCoin)(r,t,i)),{},{sender:o})}));return function(t){return e.apply(this,arguments)}}(),i.buildEncodedTxFromApprove=function(e){throw new S.NotImplemented},i.updateEncodedTxTokenApprove=function(e,t){throw new S.NotImplemented},i.updateEncodedTx=function(){var e=(0,y.default)((function*(e,t,r){var n,i=e;if("transfer"===r.type&&[K.APTOS_NATIVE_TRANSFER_FUNC,K.APTOS_TRANSFER_FUNC].includes(null!=(n=null==i?void 0:i.function)?n:"")){var o=(yield this.engine.getNativeTokenInfo(this.networkId)).decimals,a=t.amount,c=i.arguments||[],s=(0,u.default)(c,1)[0];i.arguments=[s,new(x())(a).shiftedBy(o).toFixed()]}return Promise.resolve(i)}));return function(t,r,n){return e.apply(this,arguments)}}(),i.buildUnsignedTxFromEncodedTx=function(){var e=(0,y.default)((function*(e){var t=e,r=BigInt(Math.floor(Date.now()/1e3)+100);if(l()(e.bscTxn)||o()(e.bscTxn))e.expiration_timestamp_secs&&BigInt(e.expiration_timestamp_secs)<r&&(t.expiration_timestamp_secs=r.toString());else{var n=new T.BCS.Deserializer((0,m.hexToBytes)(e.bscTxn)),i=T.TxnBuilderTypes.RawTransaction.deserialize(n),a=new T.TxnBuilderTypes.RawTransaction(i.sender,i.sequence_number,i.payload,i.max_gas_amount,i.gas_unit_price,i.expiration_timestamp_secs>r?i.expiration_timestamp_secs:r,i.chain_id),u=new T.BCS.Serializer;a.serialize(u),t.bscTxn=(0,m.bytesToHex)(u.getBytes())}var c=yield this.getDbAccount();return Promise.resolve({inputs:[{address:(0,B.stripHexPrefix)(c.address),value:new(x())(0),publicKey:(0,B.stripHexPrefix)(c.pub)}],outputs:[],payload:{encodedTx:t},encodedTx:t})}));return function(t){return e.apply(this,arguments)}}(),i.fetchFeeInfo=function(){var e=(0,y.default)((function*(e,t){var r,i,o=ce(ce({},e),{},{gas_unit_price:"100"}),a=(o.max_gas_amount,(0,n.default)(o,ae)),c=yield this.getClient(),s=yield this.getNetwork();if(t){var d;if(e.bscTxn&&(null==(d=e.bscTxn)?void 0:d.length)>0){var l=new T.BCS.Deserializer((0,m.hexToBytes)(e.bscTxn)),f=T.TxnBuilderTypes.RawTransaction.deserialize(l);r=f.max_gas_amount.toString(),i=f.gas_unit_price.toString()}else{var p,y;r=null!=(p=e.gas_unit_price)?p:K.DEFAULT_GAS_LIMIT_NATIVE_TRANSFER,i=null!=(y=e.gas_unit_price)?y:"100"}return{nativeSymbol:s.symbol,nativeDecimals:s.decimals,feeSymbol:s.feeSymbol,feeDecimals:s.feeDecimals,limit:r,prices:[(0,N.convertFeeValueToGwei)({value:i,network:s})],defaultPresetIndex:"0"}}var h=yield Promise.all([c.client.transactions.estimateGasPrice(),this.buildUnsignedTxFromEncodedTx(a)]),v=(0,u.default)(h,2),g=v[0],w=v[1];try{var I,A,E,O,b=w.encodedTx;if(b.bscTxn&&(null==(I=b.bscTxn)?void 0:I.length)>0){var P=new T.BCS.Deserializer((0,m.hexToBytes)(b.bscTxn));O=T.TxnBuilderTypes.RawTransaction.deserialize(P)}else O=yield(0,K.generateUnsignedTransaction)(c,w);var C=new Uint8Array(64),D=(yield(0,K.buildSignedTx)(O,null!=(A=null==(E=w.inputs)?void 0:E[0].publicKey)?A:"",(0,m.bytesToHex)(C))).rawTx,B=yield(yield this.getClient()).submitBCSSimulation((0,m.hexToBytes)(D),{estimateGasUnitPrice:!0,estimateMaxGasAmount:!0});if(!B||0===B.length)throw new Error;var k=null==B?void 0:B[0],_=e.function===K.APTOS_NATIVE_TRANSFER_FUNC,R=new(x())(k.gas_used);if(R.isEqualTo(0)||!_&&!k.success)throw(0,K.convertRpcError)(k.vm_status);r=x().min(R.multipliedBy(2),new(x())(k.max_gas_amount)).toFixed(0),i=(0,N.convertFeeValueToGwei)({value:k.gas_unit_price,network:s})}catch(H){if(H instanceof S.OneKeyError)throw H;r=e.function===K.APTOS_NATIVE_TRANSFER_FUNC||e.function===K.APTOS_TRANSFER_FUNC?K.DEFAULT_GAS_LIMIT_NATIVE_TRANSFER:K.DEFAULT_GAS_LIMIT_TRANSFER,i=(0,N.convertFeeValueToGwei)({value:g.gas_estimate.toString(),network:s})}return{nativeSymbol:s.symbol,nativeDecimals:s.decimals,feeSymbol:s.feeSymbol,feeDecimals:s.feeDecimals,limit:r,prices:[i],defaultPresetIndex:"0"}}));return function(t,r){return e.apply(this,arguments)}}(),i.broadcastTransaction=function(){var e=(0,y.default)((function*(e){var t=yield this.getClient();P.default.engine.info("broadcastTransaction START:",{rawTx:e.rawTx});try{var r=(yield t.submitSignedBCSTransaction((0,m.hexToBytes)(e.rawTx))).hash;P.default.engine.info("broadcastTransaction Done:",{txid:r,rawTx:e.rawTx});var n=!0;try{yield(0,K.waitPendingTransaction)(t,r),n=!1}catch(o){if(p()(e.encodedTx,"forcePendingTx",!1))throw P.default.engine.info("broadcastTransaction wait Pending Error:",{txid:r,rawTx:e.rawTx}),o}return P.default.engine.info("broadcastTransaction wait Pending END:",{txid:r,rawTx:e.rawTx}),ce(ce({},e),{},{pendingTx:n,txid:r})}catch(o){if(o instanceof S.OneKeyInternalError)throw o;var i=(o||{}).message;throw(0,K.convertRpcError)(i)}}));return function(t){return e.apply(this,arguments)}}(),i.getExportedCredential=function(){var e=(0,y.default)((function*(e){var t=yield this.getDbAccount();if(t.id.startsWith("hd-")||t.id.startsWith("imported")){var r=this.keyring,n=Object.values(yield r.getPrivateKeys(e)),i=(0,u.default)(n,1)[0];return`0x${(0,A.decrypt)(e,i).toString("hex")}`}throw new S.OneKeyInternalError("Only credential of HD or imported accounts can be exported")}));return function(t){return e.apply(this,arguments)}}(),i.fetchOnChainHistory=function(){var e=(0,y.default)((function*(e){var t=this,r=e.localHistory,n=void 0===r?[]:r;if(e.tokenIdOnNetwork)return Promise.resolve([]);var i=yield this.getClient(),o=yield this.getDbAccount(),a=(yield this.engine.getNativeTokenInfo(this.networkId)).decimals,c=(yield i.getAccountTransactions(o.address)).map(function(){var e=(0,y.default)((function*(e){var r=n.find((function(t){return t.decodedTx.txid===e.hash}));if(r&&r.decodedTx.isFinal)return Promise.resolve(null);try{var c,s=(null==e?void 0:e.payload)||{},d=s.arguments,l=s.type_arguments,f=s.function;s.code;if(null==e||!e.payload)return yield Promise.resolve(null);var y=(0,u.default)(l,1)[0],h=p()(e,"sender",void 0),v=null==f?void 0:f.split("::"),g=(0,u.default)(v,1)[0],w=(0,K.getTransactionType)(e),m={from:h,to:g,value:""},T={type:D.IDecodedTxActionType.UNKNOWN};if(w===D.IDecodedTxActionType.NATIVE_TRANSFER||w===D.IDecodedTxActionType.TOKEN_TRANSFER){var I,A=d||[],E=(0,u.default)(A,2),b=E[0],C=E[1],N=w===D.IDecodedTxActionType.TOKEN_TRANSFER,B=D.IDecodedTxDirection.IN;h===o.address&&(B=b===o.address?D.IDecodedTxDirection.SELF:D.IDecodedTxDirection.OUT);var k=yield t.engine.getNativeTokenInfo(t.networkId),_="nativeTransfer";if(N){if(_="tokenTransfer","undefined"===typeof(k=yield t.engine.ensureTokenInDB(t.networkId,y)))throw new S.OneKeyInternalError("Failed to get token info.")}else m.to=b,m.value=C;(I={type:w,direction:B})[_]={tokenInfo:k,from:h,to:b,amount:new(x())(C).shiftedBy(-k.decimals).toFixed(),amountValue:C,extraInfo:null},T=I}else if(w===D.IDecodedTxActionType.TOKEN_ACTIVATE){var R,H,F,U,M=yield t.engine.ensureTokenInDB(t.networkId,y),j={name:null!=(R=null==M?void 0:M.name)?R:"",symbol:null!=(H=null==M?void 0:M.symbol)?H:"",decimals:null!=(F=null==M?void 0:M.decimals)?F:6,logoURI:null!=(U=null==M?void 0:M.logoURI)?U:""};"undefined"===typeof M&&(j=ce(ce({},yield(0,K.getTokenInfo)(i,y)),{},{logoURI:""})),T={type:w,tokenActivate:ce(ce({},j),{},{tokenAddress:y,networkId:t.networkId,extraInfo:null})}}else w===D.IDecodedTxActionType.FUNCTION_CALL&&(T={type:D.IDecodedTxActionType.FUNCTION_CALL,direction:D.IDecodedTxDirection.OTHER,functionCall:{target:h,functionName:null!=f?f:"",args:d,extraInfo:{}}});var L=new(x())(p()(e,"gas_used",0)).multipliedBy(p()(e,"gas_unit_price",0)),V=p()(e,"success",void 0),$=D.IDecodedTxStatus.Pending;!1===V?$=D.IDecodedTxStatus.Failed:!0===V&&($=D.IDecodedTxStatus.Confirmed);var G={txid:e.hash,owner:o.address,signer:h,nonce:0,actions:[T],status:$,networkId:t.networkId,accountId:t.accountId,encodedTx:m,extraInfo:null,totalFeeInNative:new(x())(L).shiftedBy(-a).toFixed()};return G.updatedAt=p()(e,"timestamp",(0,O.getTimeStamp)())/1e3,G.createdAt=null!=(c=null==r?void 0:r.decodedTx.createdAt)?c:G.updatedAt,G.isFinal=G.status===D.IDecodedTxStatus.Confirmed,yield t.buildHistoryTx({decodedTx:G,historyTxToMerge:r})}catch(W){P.default.common.error(W)}return Promise.resolve(null)}));return function(t){return e.apply(this,arguments)}}());return(yield Promise.all(c)).filter(Boolean)}));return function(t){return e.apply(this,arguments)}}(),i.getTransactionStatuses=function(){var e=(0,y.default)((function*(e){var t=yield this.getClient();return Promise.all(e.map(function(){var e=(0,y.default)((function*(e){try{var r=yield t.getTransactionByHash(e),n=p()(r,"success",void 0),i=E.TransactionStatus.PENDING;return!1===n?i=E.TransactionStatus.CONFIRM_BUT_FAILED:!0===n&&(i=E.TransactionStatus.CONFIRM_AND_SUCCESS),yield Promise.resolve(i)}catch(o){if("transaction_not_found"===o.errorCode)return Promise.resolve(E.TransactionStatus.NOT_FOUND)}}));return function(t){return e.apply(this,arguments)}}()))}));return function(t){return e.apply(this,arguments)}}(),i.getTransactionByHash=function(){var e=(0,y.default)((function*(e){return(yield this.getClient()).getTransactionByHash(e)}));return function(t){return e.apply(this,arguments)}}(),(0,h.default)(r)}(k.VaultBase)},565147:(e,t,r)=>{r.r(t),r.d(t,{KeyringBase:()=>s,KeyringBaseMock:()=>d});var n=r(634795),i=r(887371),o=r(545754),a=r(411987),u=r(695058);function c(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,u.default)(e);if(t){var i=(0,u.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,a.default)(this,r)}}var s=function(e){(0,o.default)(r,e);var t=c(r);function r(e){var r;return(r=t.call(this,e.options)).vault=e,r}return r.prototype.addressFromBase=function(){var e=(0,n.default)((function*(e){return this.vault.addressFromBase(e)}));return function(t){return e.apply(this,arguments)}}(),(0,i.default)(r)}(r(114540).VaultContext),d=function(e){(0,o.default)(r,e);var t=c(r);function r(){return t.apply(this,arguments)}return(0,i.default)(r)}(s)},82406:(e,t,r)=>{r.r(t),r.d(t,{KeyringHardwareBase:()=>l});var n=r(634795),i=r(887371),o=r(545754),a=r(411987),u=r(695058),c=r(799075),s=r(814817);function d(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,u.default)(e);if(t){var i=(0,u.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,a.default)(this,r)}}var l=function(e){(0,o.default)(a,e);var t=d(a);function a(){return t.apply(this,arguments)}var u=a.prototype;return u.getHardwareInfo=function(){var e=(0,n.default)((function*(){var e,t,r,n=yield this.engine.getHWDeviceByWalletId(this.vault.walletId);return{connectId:null!=(e=null==n?void 0:n.mac)?e:"",deviceId:null!=(t=null==n?void 0:n.deviceId)?t:"",deviceType:null!=(r=null==n?void 0:n.deviceType)?r:""}}));return function(){return e.apply(this,arguments)}}(),u.getWalletPassphraseState=function(){var e=(0,n.default)((function*(){var e=yield this.engine.getWallet(this.vault.walletId);return{passphraseState:null==e?void 0:e.passphraseState,useEmptyPassphrase:!(0,s.isPassphraseWallet)(e)}}));return function(){return e.apply(this,arguments)}}(),u.getHardwareSDKInstance=function(){var e=(0,n.default)((function*(){var e,t,n,i,o;return null!=(o=yield null==(e=r.g)||null==(t=e.$backgroundApiProxy)||null==(n=t.backgroundApi)||null==(i=n.serviceHardware)||null==i.getSDKInstance?void 0:i.getSDKInstance())?o:c.HardwareSDK}));return function(){return e.apply(this,arguments)}}(),u.prepareAccountByAddressIndex=function(e){throw new Error("Method not implemented.")},(0,i.default)(a)}(r(565147).KeyringBase)},810887:(e,t,r)=>{r.r(t),r.d(t,{KeyringHdBase:()=>y});var n=r(256666),i=r(634795),o=r(887371),a=r(545754),u=r(411987),c=r(695058),s=r(605851),d=r(940915);function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function f(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach((function(t){(0,n.default)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function p(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,c.default)(e);if(t){var i=(0,c.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,u.default)(this,r)}}var y=function(e){(0,a.default)(r,e);var t=p(r);function r(){return t.apply(this,arguments)}var n=r.prototype;return n.getPrivateKeys=function(){var e=(0,i.default)((function*(e,t){var r=(yield this.getDbAccount()).path.split("/"),n=t||[r.pop()],i=r.join("/"),o=(yield this.engine.dbApi.getCredential(this.walletId,e)).seed;if("undefined"===typeof o)throw new d.OneKeyInternalError("Unable to get credential.");var a=(yield this.engine.providerManager.getChainInfoByNetworkId(this.networkId)).curve;return(0,s.batchGetPrivateKeys)(a,o,e,i,n).reduce((function(e,t){var r;return f(f({},e),{},((r={})[t.path]=t.extendedKey.key,r))}),{})}));return function(t,r){return e.apply(this,arguments)}}(),n.getAddress=function(){throw new Error("Method not implemented.")},n.batchGetAddress=function(){throw new Error("Method not implemented.")},n.prepareAccountByAddressIndex=function(e){throw new Error("Method not implemented.")},(0,o.default)(r)}(r(280306).KeyringSoftwareBase)},255942:(e,t,r)=>{r.r(t),r.d(t,{KeyringImportedBase:()=>d});var n=r(634795),i=r(887371),o=r(545754),a=r(411987),u=r(695058),c=r(940915);function s(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,u.default)(e);if(t){var i=(0,u.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,a.default)(this,r)}}var d=function(e){(0,o.default)(r,e);var t=s(r);function r(){return t.apply(this,arguments)}var a=r.prototype;return a.getPrivateKeys=function(){var e=(0,n.default)((function*(e,t){if("undefined"!==typeof t)throw new c.NotImplemented("Getting private keys from extended private key");var r=(yield this.engine.dbApi.getCredential(this.accountId,e)).privateKey;if("undefined"===typeof r)throw new c.OneKeyInternalError("Unable to get credential.");return{"":r}}));return function(t,r){return e.apply(this,arguments)}}(),a.getAddress=function(){throw new Error("Method not implemented.")},a.batchGetAddress=function(){throw new Error("Method not implemented.")},a.prepareAccountByAddressIndex=function(){throw new Error("Method not implemented.")},(0,i.default)(r)}(r(280306).KeyringSoftwareBase)},280306:(e,t,r)=>{r.r(t),r.d(t,{KeyringSoftwareBase:()=>h});var n=r(196234),i=r(256666),o=r(634795),a=r(887371),u=r(545754),c=r(411987),s=r(695058),d=r(292147),l=r(940915);function f(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function p(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?f(Object(r),!0).forEach((function(t){(0,i.default)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):f(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function y(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,s.default)(e);if(t){var i=(0,s.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,c.default)(this,r)}}var h=function(e){(0,u.default)(r,e);var t=y(r);function r(){return t.apply(this,arguments)}var i=r.prototype;return i.signTransaction=function(){var e=(0,o.default)((function*(e,t){var r=t.password;if("undefined"===typeof r)throw new l.OneKeyInternalError("Software signing requires a password.");var n=yield this.getSigners(r,e.inputs.map((function(e){return e.address})));return d.default.engine.info("signTransaction",this.networkId,e),p(p({},yield this.engine.providerManager.signTransaction(this.networkId,e,n)),{},{encodedTx:e.encodedTx})}));return function(t,r){return e.apply(this,arguments)}}(),i.signMessage=function(){var e=(0,o.default)((function*(e,t){var r=this,i=t.password;if("undefined"===typeof i)throw new l.OneKeyInternalError("Software signing requires a password.");var o=yield this.getDbAccount(),a=Object.values(yield this.getSigners(i,[o.address])),u=(0,n.default)(a,1)[0];return d.default.engine.info("signMessage",this.networkId,e),Promise.all(e.map((function(e){return r.engine.providerManager.signMessage(r.networkId,e,u)})))}));return function(t,r){return e.apply(this,arguments)}}(),i.getAddress=function(){throw new Error("Method not implemented.")},i.batchGetAddress=function(){throw new Error("Method not implemented.")},i.prepareAccountByAddressIndex=function(e){throw new Error("Method not implemented.")},(0,a.default)(r)}(r(565147).KeyringBase)},701625:(e,t,r)=>{r.r(t),r.d(t,{KeyringWatchingBase:()=>d});var n=r(634795),i=r(887371),o=r(545754),a=r(411987),u=r(695058),c=r(940915);function s(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,u.default)(e);if(t){var i=(0,u.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,a.default)(this,r)}}var d=function(e){(0,o.default)(r,e);var t=s(r);function r(){return t.apply(this,arguments)}var a=r.prototype;return a.signTransaction=function(){var e=(0,n.default)((function*(e,t){throw new c.OneKeyInternalError("signTransaction is not supported for watching accounts")}));return function(t,r){return e.apply(this,arguments)}}(),a.signMessage=function(){var e=(0,n.default)((function*(e,t){throw new c.OneKeyInternalError("signMessage is not supported for watching accounts")}));return function(t,r){return e.apply(this,arguments)}}(),a.getAddress=function(){throw new Error("Method not implemented.")},a.batchGetAddress=function(){throw new Error("Method not implemented.")},a.prepareAccountByAddressIndex=function(){throw new Error("Method not implemented.")},(0,i.default)(r)}(r(565147).KeyringBase)},153546:(e,t,r)=>{r.r(t),r.d(t,{convertDeviceError:()=>u});var n=r(703599),i=r(302478),o=r(292147);r(213208);function a(e,t){return"string"!==typeof t?null:e===n.HardwareErrorCode.DeviceInitializeFailed&&t.includes("ECONNABORTED")?new i.ConnectTimeoutError({message:t}):t.includes("Bridge network error")?new i.BridgeNetworkError({message:t}):null}function u(e){var t,r=e||{},u=r.code,c=r.error,s=r.message,d=null!=(t=null!=c?c:s)?t:"Unknown error";if(a(u,d))return a(u,d);switch(o.default.hardwareSDK.info("Device Utils Convert Device Error:",u,d),u){case n.HardwareErrorCode.UnknownError:return new i.UnknownHardwareError(e);case n.HardwareErrorCode.DeviceFwException:return new i.FirmwareVersionTooLow(e);case n.HardwareErrorCode.DeviceUnexpectedMode:return"string"===typeof d&&-1!==d.indexOf("ui-device_bootloader_mode")?new i.NotInBootLoaderMode(e):new i.UnknownHardwareError(e);case n.HardwareErrorCode.DeviceCheckDeviceIdError:return new i.DeviceNotSame(e);case n.HardwareErrorCode.DeviceNotFound:return new i.DeviceNotFind(e);case n.HardwareErrorCode.DeviceUnexpectedBootloaderMode:return new i.NotInBootLoaderMode(e);case n.HardwareErrorCode.DeviceInterruptedFromOutside:case n.HardwareErrorCode.DeviceInterruptedFromUser:return new i.UserCancelFromOutside(e);case n.HardwareErrorCode.DeviceNotSupportPassphrase:return new i.NotSupportPassphraseError(e);case n.HardwareErrorCode.IFrameLoadFail:return new i.InitIframeLoadFail(e);case n.HardwareErrorCode.IframeTimeout:return new i.InitIframeTimeout(e);case n.HardwareErrorCode.FirmwareUpdateDownloadFailed:return new i.FirmwareDownloadFailed(e);case n.HardwareErrorCode.FirmwareUpdateManuallyEnterBoot:return new i.FirmwareUpdateManuallyEnterBoot(e);case n.HardwareErrorCode.FirmwareUpdateAutoEnterBootFailure:return new i.FirmwareUpdateAutoEnterBootFailure(e);case n.HardwareErrorCode.FirmwareUpdateLimitOneDevice:return new i.FirmwareUpdateLimitOneDevice(e);case n.HardwareErrorCode.CallMethodNeedUpgradeFirmware:return new i.FirmwareVersionTooLow(e);case n.HardwareErrorCode.NewFirmwareUnRelease:return new i.NewFirmwareUnRelease(e);case n.HardwareErrorCode.NewFirmwareForceUpdate:return new i.NewFirmwareForceUpdate(e);case n.HardwareErrorCode.NetworkError:return new i.NetworkError(e);case n.HardwareErrorCode.BlePermissionError:return new i.NeedBluetoothTurnedOn(e);case n.HardwareErrorCode.BleLocationError:return new i.NeedBluetoothPermissions({message:d});case n.HardwareErrorCode.BleLocationServicesDisabled:return new i.BleLocationServiceError({message:d});case n.HardwareErrorCode.BleDeviceNotBonded:return new i.DeviceNotBonded(e);case n.HardwareErrorCode.BleDeviceBondError:return new i.DeviceBondError(e);case n.HardwareErrorCode.BleWriteCharacteristicError:return new i.BleWriteCharacteristicError(e);case n.HardwareErrorCode.BleScanError:return new i.BleScanError({message:d});case n.HardwareErrorCode.BleAlreadyConnected:return new i.BleAlreadyConnectedError(e);case n.HardwareErrorCode.RuntimeError:return-1!==d.indexOf("EIP712 blind sign is disabled")?new i.OpenBlindSign(e):-1!==d.indexOf("Unknown message")||-1!==d.indexOf("Failure_UnexpectedMessage")?new i.UnknownMethod(e):new i.UnknownHardwareError(e);case n.HardwareErrorCode.PinInvalid:return new i.InvalidPIN(e);case n.HardwareErrorCode.DeviceCheckPassphraseStateError:return new i.InvalidPassphrase(e);case n.HardwareErrorCode.DeviceOpenedPassphrase:return new i.DeviceOpenedPassphrase(e);case n.HardwareErrorCode.DeviceNotOpenedPassphrase:return new i.DeviceNotOpenedPassphrase(e);case n.HardwareErrorCode.PinCancelled:case n.HardwareErrorCode.ActionCancelled:return new i.UserCancel(e);case n.HardwareErrorCode.BridgeNotInstalled:case i.CustomOneKeyHardwareError.NeedOneKeyBridge:return new i.NeedOneKeyBridge(e);case n.HardwareErrorCode.BridgeNetworkError:return new i.BridgeNetworkError(e);case n.HardwareErrorCode.BridgeTimeoutError:return new i.BridgeTimeoutError(e);case n.HardwareErrorCode.PollingTimeout:return new i.ConnectTimeoutError(e);case n.HardwareErrorCode.PollingStop:return new i.ConnectPollingStopError(e);case n.HardwareErrorCode.BlindSignDisabled:return new i.OpenBlindSign(e);case n.HardwareErrorCode.FileAlreadyExists:return new i.FileAlreadyExistError(e);case n.HardwareErrorCode.CheckDownloadFileError:return new i.IncompleteFileError(e);case n.HardwareErrorCode.NotInSigningMode:return new i.NotInSigningModeError(e);case n.HardwareErrorCode.DataOverload:return new i.DeviceDataOverload(e);default:return new i.UnknownHardwareError(e)}}}}]);